# ModSecurity Configuration for WorkShelf
# Enable ModSecurity WAF
SecRuleEngine On

# Request body handling
SecRequestBodyAccess On
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyLimitAction Reject

# Response body handling  
SecResponseBodyAccess Off
SecResponseBodyMimeType text/plain text/html text/xml

# File upload handling
SecTmpDir /tmp/
SecDataDir /tmp/

# Debug logging (change to Off in production)
SecDebugLog /var/log/nginx/modsec_debug.log
SecDebugLogLevel 0

# Audit logging
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/nginx/modsec_audit.log

# Argument separator
SecArgumentSeparator &

# Upload directory
SecUploadDir /tmp/
SecUploadKeepFiles Off

# Unicode code point check
SecUnicodeMapFile /etc/nginx/modsecurity/unicode.mapping 20127

# OWASP Core Rule Set (CRS) v4 - Paranoia Level 1
SecAction \
  "id:900000,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:tx.paranoia_level=1"

# Anomaly Scoring Threshold
SecAction \
  "id:900110,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:tx.inbound_anomaly_score_threshold=5,\
   setvar:tx.outbound_anomaly_score_threshold=4"

# Application specific settings
SecAction \
  "id:900200,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:tx.allowed_methods=GET HEAD POST OPTIONS PUT PATCH DELETE,\
   setvar:tx.allowed_request_content_type=application/json|application/x-www-form-urlencoded|multipart/form-data|text/plain,\
   setvar:tx.allowed_http_versions=HTTP/1.0 HTTP/1.1 HTTP/2 HTTP/2.0,\
   setvar:tx.restricted_extensions=.asa/ .asax/ .ascx/ .axd/ .backup/ .bak/ .bat/ .cdx/ .cer/ .cfg/ .cmd/ .com/ .config/ .conf/ .cs/ .csproj/ .csr/ .dat/ .db/ .dbf/ .dll/ .dos/ .htr/ .htw/ .ida/ .idc/ .idq/ .inc/ .ini/ .key/ .licx/ .lnk/ .log/ .mdb/ .old/ .pass/ .pdb/ .pol/ .printer/ .pwd/ .resources/ .resx/ .sql/ .sys/ .vb/ .vbs/ .vbproj/ .vsdisco/ .webinfo/ .xsd/ .xsx/,\
   setvar:tx.restricted_headers=/proxy/ /lock-token/ /content-range/ /translate/ /if/,\
   setvar:tx.static_extensions=/.jpg/ /.jpeg/ /.png/ /.gif/ /.js/ /.css/ /.ico/ /.svg/ /.webp/"

# Custom rules for WorkShelf
# Block common attack patterns
SecRule REQUEST_URI "@rx (?i)(\.\./|etc/passwd|cmd\.exe|/bin/)" \
  "id:1000,\
   phase:1,\
   block,\
   t:none,t:urlDecodeUni,\
   msg:'Path Traversal Attack',\
   severity:CRITICAL,\
   setvar:tx.anomaly_score=+5"

# SQL Injection detection
SecRule ARGS|ARGS_NAMES "@rx (?i)(union.*select|insert.*into|delete.*from|drop.*table)" \
  "id:1001,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,t:lowercase,\
   msg:'SQL Injection Attempt',\
   severity:CRITICAL,\
   setvar:tx.anomaly_score=+5"

# XSS detection
SecRule ARGS|ARGS_NAMES "@rx (?i)(<script|javascript:|onerror=|onload=)" \
  "id:1002,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,t:htmlEntityDecode,\
   msg:'XSS Attempt Detected',\
   severity:CRITICAL,\
   setvar:tx.anomaly_score=+5"

# Rate limiting - max 100 requests per IP per minute
SecAction \
  "id:1100,\
   phase:5,\
   pass,\
   nolog,\
   initcol:ip=%{REMOTE_ADDR},\
   setvar:ip.requests=+1,\
   expirevar:ip.requests=60"

SecRule IP:REQUESTS "@gt 100" \
  "id:1101,\
   phase:1,\
   deny,\
   status:429,\
   msg:'Rate limit exceeded',\
   setvar:ip.blocked=1"
