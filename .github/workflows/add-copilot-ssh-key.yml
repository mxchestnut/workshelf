name: Add Copilot SSH Key

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "add" to confirm'
        required: true

jobs:
  add-key:
    name: Add SSH Key
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'add'
    
    steps:
      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/workshelf-key.pem
          chmod 600 ~/.ssh/workshelf-key.pem
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
      
      - name: Add Copilot SSH Key to Server
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ubuntu
        run: |
          ssh -i ~/.ssh/workshelf-key.pem $EC2_USER@$EC2_HOST bash << 'EOF'
            echo "ðŸ”‘ Adding Copilot SSH key..."
            
            # Create .ssh directory if it doesn't exist
            mkdir -p ~/.ssh
            chmod 700 ~/.ssh
            
            # The key to add
            NEW_KEY="ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIBgOsMSTPFFLDfw6VuhL+OTMcgoWbk5lijd38R9KJiqw copilot-workshelf-access"
            
            # Check if key already exists
            if grep -q "$NEW_KEY" ~/.ssh/authorized_keys 2>/dev/null; then
              echo "âš ï¸  Key already exists"
            else
              echo "$NEW_KEY" >> ~/.ssh/authorized_keys
              chmod 600 ~/.ssh/authorized_keys
              echo "âœ… SSH key added successfully!"
            fi
            
            # Show all key fingerprints for verification
            echo "ðŸ“‹ Current authorized keys:"
            ssh-keygen -lf ~/.ssh/authorized_keys
          EOF
