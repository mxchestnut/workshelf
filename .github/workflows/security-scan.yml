name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual triggers

jobs:
  python-security:
    name: Python Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install pip-audit
          pip install -r requirements.txt
      
      - name: Run pip-audit
        id: audit
        run: |
          cd backend
          pip-audit --desc --format json --output audit-report.json || true
          pip-audit --desc
        continue-on-error: true
      
      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: python-security-audit
          path: backend/audit-report.json
          retention-days: 30
      
      - name: Check for vulnerabilities
        run: |
          cd backend
          # Fail if critical or high vulnerabilities found
          if pip-audit --desc --format json | jq -e '.dependencies[] | select(.vulns[].severity == "HIGH" or .vulns[].severity == "CRITICAL")' > /dev/null 2>&1; then
            echo "âŒ Critical or high severity vulnerabilities found!"
            exit 1
          fi
          echo "âœ… No critical or high severity vulnerabilities"
  
  npm-security:
    name: npm Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Run npm audit
        id: npm-audit
        run: |
          cd frontend
          npm audit --json > npm-audit.json || true
          npm audit
        continue-on-error: true
      
      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: npm-security-audit
          path: frontend/npm-audit.json
          retention-days: 30
      
      - name: Check for high vulnerabilities
        run: |
          cd frontend
          # Fail if high or critical vulnerabilities found
          HIGH_VULNS=$(npm audit --json | jq -r '.metadata.vulnerabilities.high // 0')
          CRITICAL_VULNS=$(npm audit --json | jq -r '.metadata.vulnerabilities.critical // 0')
          
          if [ "$HIGH_VULNS" -gt 0 ] || [ "$CRITICAL_VULNS" -gt 0 ]; then
            echo "âŒ Found $HIGH_VULNS high and $CRITICAL_VULNS critical vulnerabilities"
            exit 1
          fi
          echo "âœ… No high or critical vulnerabilities"
  
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [python-security, npm-security]
    if: always()
    steps:
      - name: Download Python audit
        uses: actions/download-artifact@v7
        with:
          name: python-security-audit
          path: ./reports
        continue-on-error: true
      
      - name: Download npm audit
        uses: actions/download-artifact@v7
        with:
          name: npm-security-audit
          path: ./reports
        continue-on-error: true
      
      - name: Generate summary
        run: |
          echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f reports/audit-report.json ]; then
            echo "### Python Dependencies" >> $GITHUB_STEP_SUMMARY
            VULN_COUNT=$(jq '[.dependencies[].vulns] | flatten | length' reports/audit-report.json || echo "0")
            echo "- Vulnerabilities found: $VULN_COUNT" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f reports/npm-audit.json ]; then
            echo "### npm Dependencies" >> $GITHUB_STEP_SUMMARY
            TOTAL=$(jq -r '.metadata.vulnerabilities.total // 0' reports/npm-audit.json || echo "0")
            echo "- Total vulnerabilities: $TOTAL" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Detailed reports available in workflow artifacts" >> $GITHUB_STEP_SUMMARY
