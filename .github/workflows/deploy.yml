name: Deploy to Production

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      confirm:
        description: 'Type "deploy" to confirm'
        required: true
      skip_tests:
        description: 'Skip tests (not recommended)'
        type: boolean
        default: false

jobs:
  # Gate: ensure CI passed on this commit
  verify-ci:
    name: Verify CI Status
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'deploy'
    
    steps:
      - name: Check CI status
        if: ${{ !inputs.skip_tests }}
        uses: actions/github-script@v7
        with:
          script: |
            // Get the latest commit on main branch
            const { data: ref } = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'heads/main'
            });
            const mainSha = ref.object.sha;
            
            // Check CI for that commit
            const runs = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ci.yml',
              head_sha: mainSha,
              status: 'completed',
            });
            
            const ciRun = runs.data.workflow_runs[0];
            if (!ciRun || ciRun.conclusion !== 'success') {
              core.setFailed(`CI workflow must pass before deploying. Latest main SHA: ${mainSha}, CI conclusion: ${ciRun?.conclusion || 'not found'}`);
            }
            
            core.info(`‚úÖ CI passed for main branch commit ${mainSha}`);
          

  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: verify-ci
    if: github.event.inputs.confirm == 'deploy'
    environment:
      name: production
      url: https://workshelf.dev
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup SSH
        env:
          # actionlint: ignore
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/workshelf-key.pem
          chmod 600 ~/.ssh/workshelf-key.pem
          # actionlint: ignore
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to EC2
        env:
          # actionlint: ignore
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ubuntu
          GIT_SHA: ${{ github.sha }}
        run: |
          ssh -i ~/.ssh/workshelf-key.pem $EC2_USER@$EC2_HOST << 'DEPLOY'
            set -e
            cd /home/ubuntu/workshelf
            
            echo "üîß Fixing git permissions..."
            sudo chown -R ubuntu:ubuntu /home/ubuntu/workshelf/.git
            
            echo "üì• Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main
            
            echo "üîß Setting release tracking..."
            echo "GIT_SHA=${{ github.sha }}" >> .env.tmp
            grep -v "^GIT_SHA=" .env > .env.old || true
            cat .env.old .env.tmp > .env
            rm .env.tmp .env.old
            
            echo "üèóÔ∏è Rebuilding services..."
            sudo docker-compose -f deploy/docker-compose.prod.yml build --no-cache backend frontend
            
            echo "‚ôªÔ∏è  Restarting all services..."
            sudo docker-compose -f deploy/docker-compose.prod.yml down
            
            # Clean up ALL docker resources
            echo "üßπ Cleaning up Docker..."
            sudo docker ps -a --format '{{.Names}}' | grep -E '(deploy-|workshelf-)' | xargs -r sudo docker rm -f || true
            sudo docker container prune -f
            sudo docker network prune -f
            
            # Check what's using the ports
            echo "üîç Checking ports..."
            sudo ss -tlnp | grep -E ':(8000|5173|9000|9001)' || echo "No processes found on target ports"
            
            # Kill any docker-proxy processes that might be stuck
            sudo pkill -9 docker-proxy || true
            sleep 10
            
            # Start services one at a time to avoid race conditions
            echo "üöÄ Starting infrastructure services..."
            sudo docker-compose -f deploy/docker-compose.prod.yml up -d redis minio vault
            sleep 15
            
            echo "üöÄ Starting application services..."
            sudo docker-compose -f deploy/docker-compose.prod.yml up -d backend frontend
            sleep 10
            
            echo "üóÑÔ∏è  Running database migrations..."
            sudo docker-compose -f deploy/docker-compose.prod.yml exec -T backend python scripts/add_store_item_to_bookshelf.py || echo "‚ö†Ô∏è  Migration already applied or failed"
            
            echo "‚ôªÔ∏è  Restarting backend to load schema changes..."
            sudo docker-compose -f deploy/docker-compose.prod.yml restart backend
            sleep 10
            
            echo "üîß Fixing CORS configuration..."
            cd deploy && sudo bash fix-cors.sh || echo "‚ö†Ô∏è  CORS fix script not available"
            cd /home/ubuntu/workshelf
            
            echo "‚è≥ Waiting for services to stabilize..."
            sleep 30
            
            echo "üè• Health checks..."
            curl -f https://api.workshelf.dev/health || exit 1
            curl -f https://workshelf.dev/health || exit 1
            
            echo "‚úÖ Deployment complete!"
          DEPLOY
      
      - name: Notify Sentry of release
        env:
          # actionlint: ignore
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          # actionlint: ignore
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
        run: |
          curl -sL https://sentry.io/get-cli/ | bash
          export SENTRY_RELEASE="${{ github.sha }}"
          sentry-cli releases new "$SENTRY_RELEASE" || true
          sentry-cli releases set-commits "$SENTRY_RELEASE" --auto || true
          sentry-cli releases finalize "$SENTRY_RELEASE" || true
          sentry-cli releases deploys "$SENTRY_RELEASE" new -e production || true
