name: Reset Keycloak Admin Password

on:
  workflow_dispatch:
    inputs:
      new_password:
        description: 'New admin password'
        required: true
        type: string
      confirm:
        description: 'Type "reset" to confirm'
        required: true

jobs:
  reset-password:
    name: Reset Keycloak Password
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'reset'
    
    steps:
      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/workshelf-key.pem
          chmod 600 ~/.ssh/workshelf-key.pem
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
      
      - name: Reset Keycloak Admin Password
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ubuntu
          NEW_PASSWORD: ${{ github.event.inputs.new_password }}
        run: |
          ssh -i ~/.ssh/workshelf-key.pem $EC2_USER@$EC2_HOST << 'EOF'
            cd /opt/workshelf
            
            echo "ðŸ”„ Resetting Keycloak admin password..."
            
            # Get the Keycloak container name
            KEYCLOAK_CONTAINER=$(sudo docker ps --filter "name=keycloak" --format "{{.Names}}" | head -1)
            
            if [ -z "$KEYCLOAK_CONTAINER" ]; then
              echo "âŒ Keycloak container not found"
              exit 1
            fi
            
            echo "Found Keycloak container: $KEYCLOAK_CONTAINER"
            
            # Reset the admin password
            sudo docker exec $KEYCLOAK_CONTAINER /opt/keycloak/bin/kcadm.sh config credentials \
              --server http://localhost:8080 \
              --realm master \
              --user admin \
              --password admin
            
            sudo docker exec $KEYCLOAK_CONTAINER /opt/keycloak/bin/kcadm.sh set-password \
              --server http://localhost:8080 \
              --realm master \
              --username admin \
              --new-password "$NEW_PASSWORD"
            
            echo "âœ… Password reset successfully!"
          EOF
