services:
  keycloak:
    image: quay.io/keycloak/keycloak:23.0
    container_name: workshelf-keycloak
    command: start-dev
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: h2@n4me#Yu!ac!6
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://ep-cold-rice-ad0d3rzt-pooler.c-2.us-east-1.aws.neon.tech:5432/neondb?sslmode=require&currentSchema=public
      KC_DB_USERNAME: neondb_owner
      KC_DB_PASSWORD: PASSWORD
      KC_HTTP_PORT: 8080
      KC_HOSTNAME_STRICT: 'false'
      KC_HOSTNAME_STRICT_HTTPS: 'false'
      KC_HTTP_ENABLED: 'true'
      KC_PROXY: edge
    ports:
    - 8080:8080
    networks:
    - workshelf
  synapse:
    image: matrixdotorg/synapse:latest
    container_name: workshelf-synapse
    environment:
      SYNAPSE_SERVER_NAME: matrix.localhost
      SYNAPSE_REPORT_STATS: 'no'
      SYNAPSE_NO_TLS: 'true'
      POSTGRES_HOST: postgres
      POSTGRES_USER: workshelf
      POSTGRES_PASSWORD: workshelf_password
      POSTGRES_DB: synapse
    ports:
    - 8008:8008
    volumes:
    - synapse_data:/data
    depends_on:
      postgres:
        condition: service_healthy
    networks:
    - workshelf
  minio:
    image: minio/minio:latest
    container_name: workshelf-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
    - 9000:9000
    - 9001:9001
    volumes:
    - minio_data:/data
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:9000/minio/health/live
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
    - workshelf
  redis:
    image: redis:7-alpine
    container_name: workshelf-redis
    ports:
    - 6379:6379
    volumes:
    - redis_data:/data
    healthcheck:
      test:
      - CMD
      - redis-cli
      - ping
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
    - workshelf
  backend:
    image: python:3.11-slim
    container_name: workshelf-backend
    working_dir: /app
    command: bash -c "pip install -q -r requirements.txt && bash start.sh"
    environment:
      DATABASE_URL: ${DATABASE_URL}
      STORAGE_DATABASE_URL: ${STORAGE_DATABASE_URL}
      KEYCLOAK_SERVER_URL: https://keycloak.workshelf.dev
      KEYCLOAK_INTERNAL_URL: http://keycloak:8080
      KEYCLOAK_REALM: workshelf
      KEYCLOAK_CLIENT_ID: workshelf-api
      SECRET_KEY: dev-secret-key-change-in-production
      REDIS_URL: redis://redis:6379
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      MATRIX_HOMESERVER: http://synapse:8008
      MATRIX_SERVER_NAME: workshelf.dev
      MATRIX_PUBLIC_HOMESERVER: https://workshelf.dev
      MATRIX_ADMIN_ACCESS_TOKEN: ${MATRIX_ADMIN_ACCESS_TOKEN}
      SENTRY_DSN: ${SENTRY_DSN:-https://a2ae80bf39b2e57c2147574ce75c860f@o4510280685977605.ingest.us.sentry.io/4510448571383808}
      ENVIRONMENT: development
    ports:
    - 8000:8000
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      keycloak:
        condition: service_started
    volumes:
    - ./backend:/app
    networks:
    - workshelf
  frontend:
    image: node:20-alpine
    container_name: workshelf-frontend
    working_dir: /app
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    environment:
      VITE_API_URL: ${VITE_API_URL:-https://workshelf.dev}
      VITE_KEYCLOAK_URL: ${VITE_KEYCLOAK_URL:-https://keycloak.workshelf.dev}
      VITE_KEYCLOAK_REALM: ${VITE_KEYCLOAK_REALM:-workshelf}
      VITE_KEYCLOAK_CLIENT_ID: ${VITE_KEYCLOAK_CLIENT_ID:-workshelf-frontend}
      VITE_MATRIX_HOMESERVER: ${VITE_MATRIX_HOMESERVER:-https://workshelf.dev}
      VITE_SENTRY_DSN: ${VITE_SENTRY_DSN:-https://b8c5190474974430cdd1396231416148@o4510280685977605.ingest.us.sentry.io/4510448574726144}
      VITE_ENVIRONMENT: ${VITE_ENVIRONMENT:-production}
      VITE_POSTHOG_KEY: ${VITE_POSTHOG_KEY:-phc_GnJ8zb09tygMcjttDyBrcY3lULGThdeQc8IpP695rpb}
      VITE_POSTHOG_HOST: ${VITE_POSTHOG_HOST:-https://us.i.posthog.com}
    ports:
    - 5173:5173
    depends_on:
    - backend
    volumes:
    - ./frontend:/app
    - /app/node_modules
    networks:
    - workshelf
  prometheus:
    image: prom/prometheus:latest
    container_name: workshelf-prometheus
    command:
    - --config.file=/etc/prometheus/prometheus.yml
    - --storage.tsdb.path=/prometheus
    - --web.console.libraries=/usr/share/prometheus/console_libraries
    - --web.console.templates=/usr/share/prometheus/consoles
    ports:
    - 9090:9090
    volumes:
    - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
    - prometheus_data:/prometheus
    depends_on:
    - backend
    networks:
    - workshelf
    restart: unless-stopped
  grafana:
    image: grafana/grafana:latest
    container_name: workshelf-grafana
    environment:
    - GF_SECURITY_ADMIN_USER=admin
    - GF_SECURITY_ADMIN_PASSWORD=admin
    - GF_USERS_ALLOW_SIGN_UP=false
    - GF_SERVER_ROOT_URL=http://localhost:3000
    ports:
    - 3000:3000
    volumes:
    - grafana_data:/var/lib/grafana
    - ./grafana-datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
    depends_on:
    - prometheus
    networks:
    - workshelf
    restart: unless-stopped
volumes:
  synapse_data: null
  minio_data: null
  redis_data: null
  prometheus_data: null
  grafana_data: null
networks:
  workshelf:
    driver: bridge
