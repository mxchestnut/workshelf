services:
  postgres:
    image: postgres:15-alpine
    container_name: npc-postgres
    environment:
      POSTGRES_DB: npc
      POSTGRES_USER: npc
      POSTGRES_PASSWORD: npc_password
    ports:
    - "127.0.0.1:5432:5432"
    volumes:
    - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U npc
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
    - npc
    restart: unless-stopped
  synapse:
    image: matrixdotorg/synapse:latest
    container_name: npc-synapse
    environment:
      SYNAPSE_SERVER_NAME: matrix.localhost
      SYNAPSE_REPORT_STATS: 'no'
      SYNAPSE_NO_TLS: 'true'
      POSTGRES_HOST: postgres
      POSTGRES_USER: npc
      POSTGRES_PASSWORD: npc_password
      POSTGRES_DB: synapse
    ports:
    - "127.0.0.1:8008:8008"
    volumes:
    - synapse_data:/data
    depends_on:
      postgres:
        condition: service_healthy
    networks:
    - npc
    restart: unless-stopped
  minio:
    image: minio/minio:latest
    container_name: npc-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
    - "127.0.0.1:9000:9000"
    - "127.0.0.1:9001:9001"
    volumes:
    - minio_data:/data
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:9000/minio/health/live
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
    - npc
    restart: unless-stopped
  redis:
    image: redis:7-alpine
    container_name: npc-redis
    ports:
    - "127.0.0.1:6379:6379"
    volumes:
    - redis_data:/data
    healthcheck:
      test:
      - CMD
      - redis-cli
      - ping
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
    - npc
    restart: unless-stopped
  backend:
    image: python:3.11-slim
    container_name: npc-backend
    working_dir: /app
    command: bash -c "pip install -q -r requirements.txt && bash start.sh"
    environment:
      DATABASE_URL: ${DATABASE_URL}
      STORAGE_DATABASE_URL: ${STORAGE_DATABASE_URL}
      AZURE_TENANT: ${AZURE_TENANT}
      AZURE_CLIENT_ID: ${AZURE_CLIENT_ID}
      AZURE_CLIENT_SECRET: ${AZURE_CLIENT_SECRET}
      SECRET_KEY: dev-secret-key-change-in-production
      REDIS_URL: redis://redis:6379
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      MATRIX_HOMESERVER: http://synapse:8008
      MATRIX_SERVER_NAME: nerd.church
      MATRIX_PUBLIC_HOMESERVER: https://matrix.nerdchurchpartners.org
      MATRIX_ADMIN_ACCESS_TOKEN: ${MATRIX_ADMIN_ACCESS_TOKEN}
      SENTRY_DSN: ${SENTRY_DSN:-https://a2ae80bf39b2e57c2147574ce75c860f@o4510280685977605.ingest.us.sentry.io/4510448571383808}
      ENVIRONMENT: development
    ports:
    - 8000:8000
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
    - ./backend:/app
    networks:
    - npc
    restart: unless-stopped
  frontend:
    image: node:20-alpine
    container_name: npc-frontend
    working_dir: /app
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    environment:
      VITE_API_URL: ${VITE_API_URL:-https://api.nerdchurchpartners.org}
      VITE_AZURE_CLIENT_ID: ${AZURE_CLIENT_ID}
      VITE_AZURE_TENANT: ${AZURE_TENANT}
      VITE_MATRIX_HOMESERVER: ${VITE_MATRIX_HOMESERVER:-https://matrix.nerdchurchpartners.org}
      VITE_SENTRY_DSN: ${VITE_SENTRY_DSN:-https://b8c5190474974430cdd1396231416148@o4510280685977605.ingest.us.sentry.io/4510448574726144}
      VITE_ENVIRONMENT: ${VITE_ENVIRONMENT:-production}
      VITE_POSTHOG_KEY: ${VITE_POSTHOG_KEY:-phc_GnJ8zb09tygMcjttDyBrcY3lULGThdeQc8IpP695rpb}
      VITE_POSTHOG_HOST: ${VITE_POSTHOG_HOST:-https://us.i.posthog.com}
    ports:
    - 5173:5173
    depends_on:
    - backend
    volumes:
    - ./frontend:/app
    - /app/node_modules
    networks:
    - npc
    restart: unless-stopped
  prometheus:
    image: prom/prometheus:latest
    container_name: npc-prometheus
    command:
    - --config.file=/etc/prometheus/prometheus.yml
    - --storage.tsdb.path=/prometheus
    - --web.console.libraries=/usr/share/prometheus/console_libraries
    - --web.console.templates=/usr/share/prometheus/consoles
    ports:
    - "127.0.0.1:9090:9090"
    volumes:
    - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
    - prometheus_data:/prometheus
    depends_on:
    - backend
    networks:
    - npc
    restart: unless-stopped
  grafana:
    image: grafana/grafana:latest
    container_name: npc-grafana
    environment:
    - GF_SECURITY_ADMIN_USER=admin
    - GF_SECURITY_ADMIN_PASSWORD=admin
    - GF_USERS_ALLOW_SIGN_UP=false
    - GF_SERVER_ROOT_URL=http://localhost:3000
    ports:
    - "127.0.0.1:3000:3000"
    volumes:
    - grafana_data:/var/lib/grafana
    - ./grafana-datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
    depends_on:
    - prometheus
    networks:
    - npc
    restart: unless-stopped
  vault:
    image: hashicorp/vault:latest
    container_name: npc-vault
    cap_add:
    - IPC_LOCK
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: ${VAULT_ROOT_TOKEN:-npc-dev-token}
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
    ports:
    - "127.0.0.1:8200:8200"
    volumes:
    - vault_data:/vault/data
    - vault_logs:/vault/logs
    command: server -dev -dev-root-token-id=${VAULT_ROOT_TOKEN:-npc-dev-token}
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
    - npc
    restart: unless-stopped
volumes:
  postgres_data: null
  synapse_data: null
  minio_data: null
  redis_data: null
  prometheus_data: null
  grafana_data: null
  vault_data: null
  vault_logs: null
networks:
  npc:
    driver: bridge
