services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: npc-backend:latest
    container_name: npc-backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    networks:
      - npc
    environment:
      # Database
      DATABASE_URL: ${DATABASE_URL}
      STORAGE_DATABASE_URL: ${STORAGE_DATABASE_URL}
      
      # Security
      SECRET_KEY: ${SECRET_KEY}
      
      # Keycloak
      KEYCLOAK_SERVER_URL: https://keycloak.nerdchurchpartners.org
      KEYCLOAK_INTERNAL_URL: http://npc-keycloak:8080
      KEYCLOAK_REALM: npc
      KEYCLOAK_CLIENT_ID: npc-api
      
      # Redis
      REDIS_URL: redis://npc-redis:6379
      
      # MinIO
      MINIO_ENDPOINT: npc-minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      
      # Matrix
      MATRIX_HOMESERVER: http://npc-synapse:8008
      MATRIX_SERVER_NAME: nerd.church
      MATRIX_PUBLIC_HOMESERVER: https://matrix.nerdchurchpartners.org
      MATRIX_ADMIN_ACCESS_TOKEN: ${MATRIX_ADMIN_ACCESS_TOKEN}
      
      # Monitoring
      SENTRY_DSN: ${SENTRY_DSN}
      ENVIRONMENT: production
      GIT_SHA: ${GIT_SHA:-unknown}
    depends_on:
      - keycloak
      - redis
      - minio
    command: bash -c "pip install -q -r requirements.txt && bash start.sh"
    working_dir: /app

  keycloak:
    image: quay.io/keycloak/keycloak:23.0
    container_name: npc-keycloak
    restart: unless-stopped
    ports:
      - "127.0.0.1:8080:8080"
    networks:
      - npc
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      KC_DB: postgres
      KC_DB_URL: ${KC_DB_URL}
      KC_DB_SCHEMA: keycloak
      KC_DB_USERNAME: ${KC_DB_USERNAME}
      KC_DB_PASSWORD: ${KC_DB_PASSWORD}
      KC_HTTP_PORT: 8080
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      KC_HTTP_ENABLED: "true"
      KC_PROXY: edge
    command: start-dev

  redis:
    image: redis:7-alpine
    container_name: npc-redis
    restart: unless-stopped
    networks:
      - npc
    volumes:
      - redis_data:/data

  minio:
    image: minio/minio:latest
    container_name: npc-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    ports:
      - "127.0.0.1:9000:9000"
      - "127.0.0.1:9001:9001"
    networks:
      - npc
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:-minioadmin}
    volumes:
      - minio_data:/data

  synapse:
    image: matrixdotorg/synapse:latest
    container_name: npc-synapse
    restart: unless-stopped
    ports:
      - "8008:8008"
    networks:
      - npc
    environment:
      SYNAPSE_SERVER_NAME: nerd.church
      SYNAPSE_REPORT_STATS: "no"
    volumes:
      - synapse_data:/data

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_SENTRY_DSN: ${VITE_SENTRY_DSN}
        VITE_API_URL: https://api.nerdchurchpartners.org
        VITE_KEYCLOAK_URL: https://keycloak.nerdchurchpartners.org
        VITE_KEYCLOAK_REALM: npc
        VITE_KEYCLOAK_CLIENT_ID: npc-frontend
        VITE_ENVIRONMENT: production
    image: npc-frontend:latest
    container_name: npc-frontend
    restart: unless-stopped
    ports:
      - "5173:80"
    networks:
      - npc

networks:
  npc:
    name: npc_network
    driver: bridge

volumes:
  redis_data:
  minio_data:
  synapse_data:
